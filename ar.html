<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <title>WebGL AR Face Filter - ÎîîÎ≤ÑÍ∑∏ Î≤ÑÏ†Ñ</title>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover,user-scalable=no" />
  <style>
    * { box-sizing: border-box; }
    html, body { 
      margin: 0; 
      padding: 0;
      height: 100%; 
      background: #000; 
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      overflow: hidden;
      touch-action: manipulation;
    }
    
    #ar-container { 
      position: fixed; 
      inset: 0; 
      z-index: 1;
    }
    
    #ui { 
      position: fixed; 
      inset: 0; 
      display: flex; 
      flex-direction: column;
      align-items: center; 
      justify-content: center; 
      background: rgba(0,0,0,0.9);
      z-index: 100;
    }
    
    #start {
      padding: 16px 32px; 
      font-size: 18px; 
      border-radius: 50px; 
      border: 2px solid #667eea;
      background: #667eea;
      color: white; 
      font-weight: 700; 
      cursor: pointer;
      transition: all 0.3s ease;
      min-width: 200px;
    }
    
    #start:hover {
      background: #5a67d8;
      border-color: #5a67d8;
    }
    
    #start:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }
    
    #debug {
      position: fixed;
      top: 10px;
      left: 10px;
      background: rgba(0,0,0,0.8);
      color: #00ff00;
      padding: 10px;
      font-family: monospace;
      font-size: 12px;
      border-radius: 5px;
      max-width: 300px;
      z-index: 200;
      white-space: pre-wrap;
      max-height: 200px;
      overflow-y: auto;
    }
    
    #status {
      color: white;
      margin-top: 20px;
      text-align: center;
      padding: 0 20px;
    }
    
    .loading-spinner {
      width: 40px;
      height: 40px;
      border: 4px solid rgba(255,255,255,0.3);
      border-radius: 50%;
      border-top-color: #667eea;
      animation: spin 1s ease-in-out infinite;
      margin: 20px auto;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    #video {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    
    #canvas {
      position: absolute;
      top: 0;
      left: 0;
      pointer-events: none;
      z-index: 10;
    }

    #controls {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 50;
      display: none;
      gap: 10px;
    }

    .control-btn {
      background: rgba(255,255,255,0.2);
      border: 1px solid rgba(255,255,255,0.3);
      color: white;
      padding: 12px 20px;
      border-radius: 25px;
      cursor: pointer;
      backdrop-filter: blur(10px);
      transition: all 0.3s ease;
      font-size: 14px;
    }

    #capture-photo {
      width: 80px;
      height: 80px;
      border-radius: 40px;
      background: rgba(255,255,255,0.2);
      border: 2px solid rgba(255,255,255,0.6);
      color: #fff;
      font-size: 16px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .dropdown {
      position: relative;
    }

    .dropdown-list {
      position: absolute;
      bottom: 100%;
      left: 0;
      background: rgba(0,0,0,0.8);
      border: 1px solid rgba(255,255,255,0.3);
      border-radius: 8px;
      display: none;
      flex-direction: column;
      margin-bottom: 8px;
    }

    .dropdown-list.show {
      display: flex;
    }

    .dropdown-item {
      padding: 8px 12px;
      color: #fff;
      cursor: pointer;
      white-space: nowrap;
    }

    .dropdown-item:hover {
      background: rgba(255,255,255,0.2);
    }

    .filter-thumb {
      width: 80px;
      height: 80px;
      object-fit: contain;
      margin: 4px;
      cursor: pointer;
    }

    #filter-popup {
      position: fixed;
      inset: 0;
      display: none;
      align-items: center;
      justify-content: center;
      background: rgba(0,0,0,0.5);
      z-index: 60;
      gap: 20px;
    }

    #filter-popup.show {
      display: flex;
    }

    .control-btn:hover {
      background: rgba(255,255,255,0.3);
    }
  </style>
</head>
<body>
  <!-- ÎîîÎ≤ÑÍ∑∏ Ï†ïÎ≥¥ -->
  <div id="debug"></div>

  <!-- UI Î†àÏù¥Ïñ¥ -->
  <div id="ui">
    <button id="start">üé≠ Ïπ¥Î©îÎùº ÏãúÏûë</button>
    <div id="status">Ïπ¥Î©îÎùº Í∂åÌïúÏùÑ ÌóàÏö©Ìï¥Ï£ºÏÑ∏Ïöî</div>
  </div>

  <!-- Ïª®Ìä∏Î°§ Î≤ÑÌäºÎì§ -->
  <div id="controls">
    <button class="control-btn" id="toggle-debug">Î©îÏãúÏßÄÏ∞Ω Ïó¥Í∏∞/Îã´Í∏∞</button>
    <button class="control-btn" id="filter-select">ÌïÑÌÑ∞ ÏÑ†ÌÉù</button>
    <button class="control-btn" id="switch-camera">Ïπ¥Î©îÎùº Ï†ÑÌôò</button>
    <button id="capture-photo">Ï¥¨ÏòÅ</button>
  </div>
  <div id="filter-popup">
    <img src="filters/Candy.png" class="filter-thumb" data-index="0" />
    <img src="filters/Cookie.png" class="filter-thumb" data-index="1" />
    <img src="filters/Star.png" class="filter-thumb" data-index="2" />
  </div>

  <!-- AR Ïª®ÌÖåÏù¥ÎÑà -->
  <div id="ar-container"></div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/face_mesh.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.min.js"></script>

  <script>
    // ÎîîÎ≤ÑÍ∑∏ Î°úÍ∑∏ Ìï®Ïàò
    function debugLog(message) {
      console.log(message);
      const debugEl = document.getElementById('debug');
      const timestamp = new Date().toLocaleTimeString();
      debugEl.textContent += `[${timestamp}] ${message}\n`;
      debugEl.scrollTop = debugEl.scrollHeight;
    }

    // ÏÉÅÌÉú ÏóÖÎç∞Ïù¥Ìä∏ Ìï®Ïàò
    function updateStatus(message) {
      document.getElementById('status').textContent = message;
      debugLog(`STATUS: ${message}`);
    }
const FILTERS = [
  'filters/Candy.png',
  'filters/Cookie.png',
  'filters/Star.png'
];

// Ïù¥Îßà Í∏∞Ï§Ä Ìè¨Ïù∏Ìä∏ ÏÑ†ÌÉù: 10(Ïù¥Îßà Ï§ëÏã¨) ÎòêÎäî 151(Îçî ÏúÑ)
const ANCHOR_INDEX = 10;

// Ïù¥ Í∞íÏúºÎ°ú ÎØ∏ÏÑ∏ÌïòÍ≤å ÏúÑÎ°ú Îçî Ïò¨Î¶¨Í≥† Ïã∂ÏúºÎ©¥ 0.02 ~ 0.15 ÏÇ¨Ïù¥ÏóêÏÑú Ï°∞Ï†à
const OFFSET_Y = -0.1;

    class SimpleARFilter {
      constructor() {
        this.video = null;
        this.canvas = null;
        this.scene = null;
        this.camera = null;
        this.renderer = null;
        this.filterGroup = null;
        this.isRunning = false;
        this.facingMode = 'user';
        this.faceMesh = null;
        this.cameraUtils = null;

        debugLog('ARFilter ÏÉùÏÑ±Ïûê Ìò∏Ï∂úÎê®');
      }

      async init() {
        this.currentFilter = Math.floor(Math.random() * FILTERS.length);
        try {
          debugLog('Ï¥àÍ∏∞Ìôî ÏãúÏûë');
          
          // 1. Ïπ¥Î©îÎùº Í∂åÌïú Ï≤¥ÌÅ¨
          debugLog('Ïπ¥Î©îÎùº Í∂åÌïú Ï≤¥ÌÅ¨ Ï§ë...');
          await this.checkCameraPermission();
          
          // 2. Ïπ¥Î©îÎùº Ïä§Ìä∏Î¶º ÌöçÎìù
          debugLog('Ïπ¥Î©îÎùº Ïä§Ìä∏Î¶º ÌöçÎìù Ï§ë...');
          await this.setupCamera();
          
          // 3. Three.js ÏÑ§Ï†ï
          debugLog('Three.js ÏÑ§Ï†ï Ï§ë...');
          this.setupThreeJS();
          
          // 4. ÌïÑÌÑ∞ ÏÉùÏÑ±
          debugLog('ÌïÑÌÑ∞ ÏÉùÏÑ± Ï§ë...');
          this.createFilter();

          // 5. FaceMesh Ï¥àÍ∏∞Ìôî
          this.faceMesh = new FaceMesh({
            locateFile: (file) =>
              `https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/${file}`,
          });
          this.faceMesh.setOptions({maxNumFaces: 1, refineLandmarks: true});
          this.faceMesh.onResults(this.onFaceResults.bind(this));
          this.cameraUtils = new Camera(this.video, {onFrame: async () => {
            await this.faceMesh.send({image: this.video});
          }});
          this.cameraUtils.start();

          // 6. Ïï†ÎãàÎ©îÏù¥ÏÖò ÏãúÏûë
          debugLog('Ïï†ÎãàÎ©îÏù¥ÏÖò ÏãúÏûë');
          this.startAnimation();
          
          debugLog('Ï¥àÍ∏∞Ìôî ÏôÑÎ£å!');
          return true;
          
        } catch (error) {
          debugLog(`Ï¥àÍ∏∞Ìôî Ïã§Ìå®: ${error.message}`);
          throw error;
        }
      }

      async checkCameraPermission() {
        try {
          if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
            throw new Error('Î∏åÎùºÏö∞Ï†ÄÍ∞Ä Ïπ¥Î©îÎùºÎ•º ÏßÄÏõêÌïòÏßÄ ÏïäÏäµÎãàÎã§');
          }
          
          const result = await navigator.permissions.query({ name: 'camera' });
          debugLog(`Ïπ¥Î©îÎùº Í∂åÌïú ÏÉÅÌÉú: ${result.state}`);
          
          return true;
        } catch (error) {
          debugLog(`Í∂åÌïú Ï≤¥ÌÅ¨ Ïã§Ìå®: ${error.message}`);
          // Í∂åÌïú Ï≤¥ÌÅ¨Í∞Ä Ïã§Ìå®Ìï¥ÎèÑ Í≥ÑÏÜç ÏßÑÌñâ
          return true;
        }
      }

      async setupCamera() {
        try {
          updateStatus('Ïπ¥Î©îÎùºÏóê Ï†ëÍ∑ºÌïòÎäî Ï§ë...');

          const container = document.getElementById('ar-container');
          container.innerHTML = '';

          const constraints = {
            video: {
              facingMode: this.facingMode,
              width: { ideal: 640, max: 1280 },
              height: { ideal: 480, max: 720 }
            },
            audio: false
          };
          
          debugLog(`Ïπ¥Î©îÎùº Ï†úÏïΩÏ°∞Í±¥: ${JSON.stringify(constraints)}`);
          
          const stream = await navigator.mediaDevices.getUserMedia(constraints);
          debugLog(`Ïä§Ìä∏Î¶º ÌöçÎìù ÏÑ±Í≥µ: ${stream.id}`);

          // ÎπÑÎîîÏò§ ÏóòÎ¶¨Î®ºÌä∏ ÏÉùÏÑ±
          this.video = document.createElement('video');
          this.video.id = 'video';
          this.video.srcObject = stream;
          this.video.autoplay = true;
          this.video.playsInline = true;
          this.video.muted = true;

          // Ïª®ÌÖåÏù¥ÎÑàÏóê Ï∂îÍ∞Ä
          container.appendChild(this.video);

          const loadedMetadata = new Promise((resolve, reject) => {
            this.video.addEventListener('loadedmetadata', () => {
              debugLog(`ÎπÑÎîîÏò§ Î©îÌÉÄÎç∞Ïù¥ÌÑ∞ Î°úÎìúÎê®: ${this.video.videoWidth}x${this.video.videoHeight}`);
              updateStatus('Ïπ¥Î©îÎùº Ïó∞Í≤∞Îê®');
              resolve();
            });

            this.video.addEventListener('error', (e) => {
              debugLog(`ÎπÑÎîîÏò§ Ïò§Î•ò: ${e.message}`);
              reject(new Error('ÎπÑÎîîÏò§ Î°úÎìú Ïã§Ìå®'));
            });

            // 5Ï¥à ÌÉÄÏûÑÏïÑÏõÉ
            setTimeout(() => {
              reject(new Error('ÎπÑÎîîÏò§ Î°úÎìú ÌÉÄÏûÑÏïÑÏõÉ'));
            }, 5000);
          });

          await this.video.play();
          await loadedMetadata;

        } catch (error) {
          debugLog(`Ïπ¥Î©îÎùº ÏÑ§Ï†ï Ïã§Ìå®: ${error.message}`);
          updateStatus(`Ïπ¥Î©îÎùº Ïò§Î•ò: ${error.message}`);
          throw error;
        }
      }

      setupThreeJS() {
        try {
          updateStatus('3D ÏóîÏßÑ Ï¥àÍ∏∞Ìôî Ï§ë...');
          
          // Ïî¨ ÏÉùÏÑ±
          this.scene = new THREE.Scene();
          debugLog('Three.js Ïî¨ ÏÉùÏÑ±Îê®');
          
          // Ïπ¥Î©îÎùº ÏÉùÏÑ±
          this.camera = new THREE.PerspectiveCamera(
            75,
            window.innerWidth / window.innerHeight,
            0.1,
            1000
          );
          this.camera.position.z = 1;
          debugLog('Three.js Ïπ¥Î©îÎùº ÏÉùÏÑ±Îê®');
          
          // Î†åÎçîÎü¨ ÏÉùÏÑ±
          this.renderer = new THREE.WebGLRenderer({
            alpha: true,
            antialias: true
          });
          this.renderer.setSize(window.innerWidth, window.innerHeight);
          this.renderer.domElement.id = 'canvas';
          
          // Ïª®ÌÖåÏù¥ÎÑàÏóê Ï∂îÍ∞Ä
          const container = document.getElementById('ar-container');
          container.appendChild(this.renderer.domElement);
          debugLog('Three.js Î†åÎçîÎü¨ ÏÉùÏÑ±Îê®');
          
          // Ï°∞Î™Ö Ï∂îÍ∞Ä
          const light = new THREE.DirectionalLight(0xffffff, 1);
          light.position.set(0, 1, 1);
          this.scene.add(light);
          
          const ambientLight = new THREE.AmbientLight(0xffffff, 0.5);
          this.scene.add(ambientLight);
          debugLog('Ï°∞Î™Ö Ï∂îÍ∞ÄÎê®');
          
          // Î¶¨ÏÇ¨Ïù¥Ï¶à Ïù¥Î≤§Ìä∏
          window.addEventListener('resize', () => this.onWindowResize());
          
          updateStatus('3D ÏóîÏßÑ Ï¥àÍ∏∞Ìôî ÏôÑÎ£å');
          
        } catch (error) {
          debugLog(`Three.js ÏÑ§Ï†ï Ïã§Ìå®: ${error.message}`);
          throw error;
        }
      }

      createFilter() {
        this.filterGroup = new THREE.Group();
        const loader = new THREE.TextureLoader();
        loader.load(FILTERS[this.currentFilter], texture => {
          const geometry = new THREE.PlaneGeometry(0.5, 0.5);
          const material = new THREE.MeshBasicMaterial({ map: texture, transparent: true });
          const mesh = new THREE.Mesh(geometry, material);
          this.filterGroup.add(mesh);
          this.scene.add(this.filterGroup);
        });
      }

      setFilter(index) {
        this.currentFilter = index;
        this.updateFilterTexture();
      }

      updateFilterTexture() {
        const loader = new THREE.TextureLoader();
        loader.load(FILTERS[this.currentFilter], texture => {
          const mesh = this.filterGroup.children[0];
          mesh.material.map = texture;
          mesh.material.needsUpdate = true;
        });
      }

      startAnimation() {
        this.isRunning = true;
        updateStatus('AR ÌïÑÌÑ∞ ÌôúÏÑ±ÌôîÎê®');
        
        const animate = () => {
          if (!this.isRunning) return;
          
          this.renderer.render(this.scene, this.camera);
          requestAnimationFrame(animate);
        };

        animate();
        debugLog('Ïï†ÎãàÎ©îÏù¥ÏÖò Î£®ÌîÑ ÏãúÏûëÎê®');
      }

onFaceResults(results) {
  if (!results.multiFaceLandmarks || !results.multiFaceLandmarks.length) return;

  const lm = results.multiFaceLandmarks[0];
  const p = lm[ANCHOR_INDEX]; // ‚Üê Ïù¥Îßà Ìè¨Ïù∏Ìä∏ ÏÇ¨Ïö©

  // MediaPipe (0~1) ‚Üí ÌôîÎ©¥ Ï†ïÍ∑úÏ¢åÌëú(-1~1) Î≥ÄÌôò
  const x = p.x * 2 - 1;
  const y = 1 - p.y * 2 + OFFSET_Y;

  // zÎäî Í≥†Ï†ïÌïòÍ±∞ÎÇò p.zÎ•º ÏÇ¥ÏßùÎßå Î∞òÏòÅ
  this.filterGroup.position.set(x, y, -0.5);
}


      onWindowResize() {
        if (this.camera && this.renderer) {
          this.camera.aspect = window.innerWidth / window.innerHeight;
          this.camera.updateProjectionMatrix();
          this.renderer.setSize(window.innerWidth, window.innerHeight);
          debugLog('ÌôîÎ©¥ ÌÅ¨Í∏∞ Ï°∞Ï†ïÎê®');
        }
      }

      stop() {
        this.isRunning = false;
        if (this.cameraUtils) this.cameraUtils.stop();
        if (this.video && this.video.srcObject) {
          this.video.srcObject.getTracks().forEach(t => t.stop());
          this.video.remove();
          debugLog('Ïπ¥Î©îÎùº Ïä§Ìä∏Î¶º Ï†ïÏßÄÎê®');
        }
        if (this.renderer && this.renderer.domElement) {
          this.renderer.domElement.remove();
        }
      }
    }

    // Î©îÏù∏ Ïï± Î°úÏßÅ
    let arApp = null;

    const filterPopup = document.getElementById('filter-popup');
    const thumbs = filterPopup.querySelectorAll('img');
    thumbs.forEach((img) => {
      img.addEventListener('click', () => {
        const idx = parseInt(img.dataset.index, 10);
        if (arApp) {
          arApp.setFilter(idx);
        }
        filterPopup.classList.remove('show');
      });
    });

    document.getElementById('filter-select').addEventListener('click', () => {
      debugLog('ÌïÑÌÑ∞ ÏÑ†ÌÉù Î≤ÑÌäº ÌÅ¥Î¶≠Îê®');
      filterPopup.classList.add('show');
    });

filterPopup.addEventListener('click', (e) => {
  if (e.target === filterPopup) {
    filterPopup.classList.remove('show');
  }
});

    const debugToggleBtn = document.getElementById('toggle-debug');
    const debugEl = document.getElementById('debug');
    debugToggleBtn.addEventListener('click', () => {
      const isHidden = debugEl.style.display === 'none';
      debugEl.style.display = isHidden ? 'block' : 'none';
      debugToggleBtn.textContent = isHidden ? 'Î©îÏãúÏßÄÏ∞Ω Îã´Í∏∞' : 'Î©îÏãúÏßÄÏ∞Ω Ïó¥Í∏∞';
    });
    debugToggleBtn.textContent = debugEl.style.display === 'none' ? 'Î©îÏãúÏßÄÏ∞Ω Ïó¥Í∏∞' : 'Î©îÏãúÏßÄÏ∞Ω Îã´Í∏∞';

    // Î∏åÎùºÏö∞Ï†Ä ÏßÄÏõê Ï≤¥ÌÅ¨
    function checkBrowserSupport() {
      const checks = {
        webgl: !!window.WebGLRenderingContext,
        getUserMedia: !!(navigator.mediaDevices && navigator.mediaDevices.getUserMedia),
        https: location.protocol === 'https:' || location.hostname === 'localhost'
      };
      
      debugLog(`Î∏åÎùºÏö∞Ï†Ä ÏßÄÏõê Ï≤¥ÌÅ¨: ${JSON.stringify(checks)}`);
      
      if (!checks.webgl) {
        throw new Error('WebGLÏùÑ ÏßÄÏõêÌïòÏßÄ ÏïäÎäî Î∏åÎùºÏö∞Ï†ÄÏûÖÎãàÎã§');
      }
      
      if (!checks.getUserMedia) {
        throw new Error('Ïπ¥Î©îÎùº APIÎ•º ÏßÄÏõêÌïòÏßÄ ÏïäÎäî Î∏åÎùºÏö∞Ï†ÄÏûÖÎãàÎã§');
      }
      
      if (!checks.https) {
        throw new Error('HTTPS ÌôòÍ≤ΩÏóêÏÑúÎßå Ïπ¥Î©îÎùºÎ•º ÏÇ¨Ïö©Ìï† Ïàò ÏûàÏäµÎãàÎã§');
      }
      
      return true;
    }

    // ÏãúÏûë Î≤ÑÌäº Ïù¥Î≤§Ìä∏
    document.getElementById('start').addEventListener('click', async () => {
      const startBtn = document.getElementById('start');
      const ui = document.getElementById('ui');
      const controls = document.getElementById('controls');
      
      try {
        debugLog('ÏãúÏûë Î≤ÑÌäº ÌÅ¥Î¶≠Îê®');
        
        // Î≤ÑÌäº ÎπÑÌôúÏÑ±Ìôî
        startBtn.disabled = true;
        startBtn.textContent = 'Ï¥àÍ∏∞Ìôî Ï§ë...';
        
        // Î∏åÎùºÏö∞Ï†Ä ÏßÄÏõê Ï≤¥ÌÅ¨
        checkBrowserSupport();
        
        // AR Ïï± ÏÉùÏÑ± Î∞è Ï¥àÍ∏∞Ìôî
        arApp = new SimpleARFilter();
        await arApp.init();

        // ÌòÑÏû¨ Î™®Îìú ÏïàÎÇ¥
        const switchBtn = document.getElementById('switch-camera');
        const currentModeKor = arApp.facingMode === 'user' ? 'Ï†ÑÎ©¥' : 'ÌõÑÎ©¥';
        const nextModeKor = arApp.facingMode === 'user' ? 'ÌõÑÎ©¥' : 'Ï†ÑÎ©¥';
        switchBtn.textContent = `Ïπ¥Î©îÎùº Ï†ÑÌôò (${nextModeKor})`;
        updateStatus(`${currentModeKor} Ïπ¥Î©îÎùº ÏÇ¨Ïö© Ï§ë`);

        // UI Ïà®Í∏∞Í∏∞ Î∞è Ïª®Ìä∏Î°§ ÌëúÏãú
        ui.style.display = 'none';
        controls.style.display = 'flex';
        
        debugLog('Ïï± ÏãúÏûë ÏôÑÎ£å');
        
      } catch (error) {
        debugLog(`Ïï± ÏãúÏûë Ïã§Ìå®: ${error.message}`);
        updateStatus(`Ïò§Î•ò: ${error.message}`);
        
        // Î≤ÑÌäº Îã§Ïãú ÌôúÏÑ±Ìôî
        startBtn.disabled = false;
        startBtn.textContent = 'Îã§Ïãú ÏãúÎèÑ';
      }
    });

    // Ïª®Ìä∏Î°§ Î≤ÑÌäº Ïù¥Î≤§Ìä∏Îì§
    document.getElementById('switch-camera').addEventListener('click', async () => {
      debugLog('Ïπ¥Î©îÎùº Ï†ÑÌôò Î≤ÑÌäº ÌÅ¥Î¶≠Îê®');
      const switchBtn = document.getElementById('switch-camera');
      switchBtn.disabled = true;

      if (arApp) {
        const prevMode = arApp.facingMode;
        arApp.facingMode = (arApp.facingMode === 'user') ? 'environment' : 'user';

        try {
          arApp.stop();
          await arApp.init();
          const currentModeKor = arApp.facingMode === 'user' ? 'Ï†ÑÎ©¥' : 'ÌõÑÎ©¥';
          const nextModeKor = arApp.facingMode === 'user' ? 'ÌõÑÎ©¥' : 'Ï†ÑÎ©¥';
          updateStatus(`${currentModeKor} Ïπ¥Î©îÎùº ÏÇ¨Ïö© Ï§ë`);
          switchBtn.textContent = `Ïπ¥Î©îÎùº Ï†ÑÌôò (${nextModeKor})`;
          debugLog(`Ïπ¥Î©îÎùºÍ∞Ä ${arApp.facingMode} Î™®ÎìúÎ°ú Ï†ÑÌôòÎê®`);
        } catch (error) {
          debugLog(`Ïπ¥Î©îÎùº Ï†ÑÌôò Ïã§Ìå®: ${error.message}`);
          updateStatus('ÌõÑÎ©¥ Ïπ¥Î©îÎùºÎ•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§. Ï†ÑÎ©¥ Ïπ¥Î©îÎùºÎ•º Í≥ÑÏÜç ÏÇ¨Ïö©Ìï©ÎãàÎã§. ÌõÑÎ©¥ Ïπ¥Î©îÎùºÍ∞Ä ÏûàÎäî Í∏∞Í∏∞ÏóêÏÑú Îã§Ïãú ÏãúÎèÑÌïòÏÑ∏Ïöî.');

          // Ïù¥Ï†Ñ Î™®ÎìúÎ°ú Î≥µÍµ¨
          arApp.facingMode = prevMode;
          try {
            arApp.stop();
            await arApp.init();
            const nextModeKor = arApp.facingMode === 'user' ? 'ÌõÑÎ©¥' : 'Ï†ÑÎ©¥';
            switchBtn.textContent = `Ïπ¥Î©îÎùº Ï†ÑÌôò (${nextModeKor})`;
          } catch (e) {
            debugLog(`Ïπ¥Î©îÎùº Î≥µÍµ¨ Ïã§Ìå®: ${e.message}`);
          }
        } finally {
          switchBtn.disabled = false;
        }
      } else {
        switchBtn.disabled = false;
      }
    });

    document.getElementById('capture-photo').addEventListener('click', () => {
      debugLog('Ï¥¨ÏòÅ Î≤ÑÌäº ÌÅ¥Î¶≠Îê®');
      if (!arApp || !arApp.video) return;

      const width = arApp.video.videoWidth;
      const height = arApp.video.videoHeight;
      const canvas = document.createElement('canvas');
      canvas.width = width;
      canvas.height = height;
      const ctx = canvas.getContext('2d');

      ctx.drawImage(arApp.video, 0, 0, width, height);

      const captureRenderer = new THREE.WebGLRenderer({ alpha: true, preserveDrawingBuffer: true });
      captureRenderer.setSize(width, height);
      captureRenderer.render(arApp.scene, arApp.camera);
      ctx.drawImage(captureRenderer.domElement, 0, 0, width, height);
      captureRenderer.dispose();

      const link = document.createElement('a');
      link.download = 'photo.png';
      link.href = canvas.toDataURL('image/png');
      link.click();
    });

    // ÌéòÏù¥ÏßÄ Ïñ∏Î°úÎìú Ïãú Ï†ïÎ¶¨
    window.addEventListener('beforeunload', () => {
      if (arApp) {
        arApp.stop();
      }
    });

    // Ï¥àÍ∏∞ ÎîîÎ≤ÑÍ∑∏ Ï†ïÎ≥¥
    debugLog('Ïä§ÌÅ¨Î¶ΩÌä∏ Î°úÎìúÎê®');
    debugLog(`User Agent: ${navigator.userAgent}`);
    debugLog(`Protocol: ${location.protocol}`);
    debugLog(`Hostname: ${location.hostname}`);
  </script>
</body>
</html>



